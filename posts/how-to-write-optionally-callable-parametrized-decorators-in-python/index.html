<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>如何在 Python 中编写可选参数的装饰器</title>
<meta name=description content>
<meta name=image content>
<meta itemprop=name content="如何在 Python 中编写可选参数的装饰器">
<meta itemprop=description content>
<meta itemprop=image content>
<meta name=og:title content="如何在 Python 中编写可选参数的装饰器">
<meta name=og:description content>
<meta name=og:url content="https://d3adloop.github.io/posts/posts/how-to-write-optionally-callable-parametrized-decorators-in-python/">
<meta name=og:site_name content="如何在 Python 中编写可选参数的装饰器">
<meta name=og:type content="article">
<meta name=article:tag content>
<link rel=stylesheet type=text/css href=https://d3adloop.github.io/posts/css/style.css>
</head>
<body>
<header>
<a href=https://d3adloop.github.io/posts/ style=float:left;color:#ff3b30>NotePad</a>
&nbsp;&nbsp;<a href=https://d3adloop.github.io/posts/archives/ style=color:#777>Archives</a>&nbsp;&nbsp;<a href=https://d3adloop.github.io/posts/about/ style=color:#777>About</a>
<a href=https://d3adloop.github.io/posts/posts/index.xml style=color:#777;float:right><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a>
</header>
<div class=content>
<h1>如何在 Python 中编写可选参数的装饰器</h1>
<aside></aside>
<p><h3 id=举个栗子>举个栗子</h3>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>pytest</span>

<span style=color:#a2f>@pytest</span><span style=color:#666>.</span>fixture  <span style=color:#408080;font-style:italic># No need to write &#39;@pytest.fixture()&#39;</span>
<span style=color:green;font-weight:700>def</span> <span style=color:#00f>app</span>():
    <span style=color:#666>...</span>

<span style=color:#a2f>@pytest</span><span style=color:#666>.</span>fixture(scope<span style=color:#666>=</span><span style=color:#ba2121>&#34;session&#34;</span>)
<span style=color:green;font-weight:700>def</span> <span style=color:#00f>server</span>():
    <span style=color:#666>...</span>
</code></pre></div><h3 id=具体实现>具体实现</h3>
<p>让我们用 <code>@logged</code> 为函数编写一个装饰器</p>
<p>它接受一个可选 <code>decimals</code> 参数来将计算结果四舍五入。如果 <code>decimals</code> 没有给出，我们根本不应该管它。</p>
<p>因此，可能的调用方式应该是：</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
<span style=color:#a2f>@logged</span>()
<span style=color:green;font-weight:700>def</span> <span style=color:#00f>test</span>():
    <span style=color:#666>...</span>

<span style=color:#a2f>@logged</span>(decimals<span style=color:#666>=</span><span style=color:#666>2</span>)
<span style=color:green;font-weight:700>def</span> <span style=color:#00f>test</span>():
    <span style=color:#666>...</span>

<span style=color:#a2f>@logged</span> <span style=color:#408080;font-style:italic># 相当于@logged() —— 实现这一点是这篇博文的目标</span>
<span style=color:green;font-weight:700>def</span> <span style=color:#00f>test</span>():
    <span style=color:#666>...</span>
</code></pre></div><p>切入正题，这是带注释的解决方案：</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>functools</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>typing</span>

<span style=color:green;font-weight:700>def</span> <span style=color:#00f>logged</span>(func: typing<span style=color:#666>.</span>Callable <span style=color:#666>=</span> <span style=color:green;font-weight:700>None</span>, decimals: <span style=color:green>int</span> <span style=color:#666>=</span> <span style=color:green;font-weight:700>None</span>) <span style=color:#666>-&gt;</span> typing<span style=color:#666>.</span>Callable:
    <span style=color:green;font-weight:700>if</span> func <span style=color:#a2f;font-weight:700>is</span> <span style=color:green;font-weight:700>None</span>:
        <span style=color:green>print</span>(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;Called with decimals=</span><span style=color:#b68;font-weight:700>{</span>decimals<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
        <span style=color:green;font-weight:700>return</span> functools<span style=color:#666>.</span>partial(logged, decimals<span style=color:#666>=</span>decimals)

    <span style=color:green>print</span>(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;Called without parameters, func=</span><span style=color:#b68;font-weight:700>{</span>func<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>.&#34;</span>)

    <span style=color:#a2f>@functools</span><span style=color:#666>.</span>wraps(func)
    <span style=color:green;font-weight:700>def</span> <span style=color:#00f>decorated</span>(<span style=color:#666>*</span>args: typing<span style=color:#666>.</span>Any, <span style=color:#666>**</span>kwargs: typing<span style=color:#666>.</span>Any) <span style=color:#666>-&gt;</span> typing<span style=color:#666>.</span>Any:
        <span style=color:green>print</span>(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;</span><span style=color:#b68;font-weight:700>{</span>func<span style=color:#666>.</span>__name__<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121> called with args=</span><span style=color:#b68;font-weight:700>{</span>args<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>, kwargs=</span><span style=color:#b68;font-weight:700>{</span>kwargs<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
        result <span style=color:#666>=</span> func(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs)
        logged_result <span style=color:#666>=</span> result <span style=color:green;font-weight:700>if</span> decimals <span style=color:#a2f;font-weight:700>is</span> <span style=color:green;font-weight:700>None</span> <span style=color:green;font-weight:700>else</span> <span style=color:green>round</span>(result, decimals)
        <span style=color:green>print</span>(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;Result: </span><span style=color:#b68;font-weight:700>{</span>logged_result<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
        <span style=color:green;font-weight:700>return</span> result

    <span style=color:green;font-weight:700>return</span> decorated
</code></pre></div><p>如果我们运行以下脚本：</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
<span style=color:#a2f>@logged</span>
<span style=color:green;font-weight:700>def</span> <span style=color:#00f>add</span>(x: <span style=color:green>float</span>, y: <span style=color:green>float</span>) <span style=color:#666>-&gt;</span> <span style=color:green>float</span>:
    <span style=color:green;font-weight:700>return</span> x <span style=color:#666>+</span> y

<span style=color:#a2f>@logged</span>(decimals<span style=color:#666>=</span><span style=color:#666>2</span>)
<span style=color:green;font-weight:700>def</span> <span style=color:#00f>mult</span>(x: <span style=color:green>float</span>, y: <span style=color:green>float</span>) <span style=color:#666>-&gt;</span> <span style=color:green>float</span>:
    <span style=color:green;font-weight:700>return</span> x <span style=color:#666>*</span> y

</code></pre></div><p>运行如下</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
add(<span style=color:#666>2</span>, <span style=color:#666>2</span>)
mult(<span style=color:#666>3</span>, <span style=color:#666>4</span>)
</code></pre></div><p>我们得到以下输出：</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
Called without parameters, func<span style=color:#666>=&lt;</span>function add at <span style=color:#666>0x10d8d8b70</span><span style=color:#666>&gt;.</span>
Called <span style=color:green;font-weight:700>with</span> decimals<span style=color:#666>=</span><span style=color:#666>2</span>
Called without parameters, func<span style=color:#666>=&lt;</span>function mult at <span style=color:#666>0x10db18a60</span><span style=color:#666>&gt;.</span>
add called <span style=color:green;font-weight:700>with</span> args<span style=color:#666>=</span>(<span style=color:#666>2</span>, <span style=color:#666>2</span>), kwargs<span style=color:#666>=</span>{}
Result: <span style=color:#666>4</span>
mult called <span style=color:green;font-weight:700>with</span> args<span style=color:#666>=</span>(<span style=color:#666>3</span>, <span style=color:#666>4</span>), kwargs<span style=color:#666>=</span>{}
Result: <span style=color:#666>12</span>
</code></pre></div><h3 id=通用实现>通用实现</h3>
<p>这个 100% 的通用实现没有任何注释和调试输出。只需将其复制粘贴到某处并根据您的需要进行调整即可。</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>functools</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>typing</span>


<span style=color:green;font-weight:700>def</span> <span style=color:#00f>decorate</span>(func: typing<span style=color:#666>.</span>Callable <span style=color:#666>=</span> <span style=color:green;font-weight:700>None</span>, <span style=color:#666>**</span>options: typing<span style=color:#666>.</span>Any) <span style=color:#666>-&gt;</span> typing<span style=color:#666>.</span>Callable:
    <span style=color:green;font-weight:700>if</span> func <span style=color:#a2f;font-weight:700>is</span> <span style=color:green;font-weight:700>None</span>:
        <span style=color:green;font-weight:700>return</span> functools<span style=color:#666>.</span>partial(decorate, <span style=color:#666>**</span>options)

    <span style=color:#a2f>@functools</span><span style=color:#666>.</span>wraps(func)
    <span style=color:green;font-weight:700>def</span> <span style=color:#00f>decorated</span>(<span style=color:#666>*</span>args: typing<span style=color:#666>.</span>Any, <span style=color:#666>**</span>kwargs: typing<span style=color:#666>.</span>Any) <span style=color:#666>-&gt;</span> typing<span style=color:#666>.</span>Any:
        <span style=color:green;font-weight:700>return</span> func(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs)

    <span style=color:green;font-weight:700>return</span> decorated

</code></pre></div><p>就是这样了。</p>
</p>
</div>
<p>Written on Dec 5, 2021.</p>
<footer>
<p>&copy; 2021 All rights reserved.</p>
</footer>
</body>
</html>